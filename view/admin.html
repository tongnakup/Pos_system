<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô POS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script>
      const session = sessionStorage.getItem("pos_user");
      if (!session) {
        window.location.href = "/view/login.html";
      } else {
        const user = JSON.parse(session);
        if (user.role !== "admin") {
          alert("‚õîÔ∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
          window.location.href = "/";
        }
      }
    </script>

    <style>
      /* --- CSS Reset & Layout --- */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Sarabun", sans-serif;
        margin: 0;
        background: #eaeff5;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: #333;
      }

      /* Custom Scrollbar (‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢) */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #bdc3c7;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #95a5a6;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: #2c3e50;
        color: white;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
        flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏î‡∏ï‡∏±‡∏ß */
      }
      .sidebar h2 {
        text-align: center;
        padding: 25px 0;
        background: #1a252f;
        margin: 0;
        font-size: 1.5em;
        position: sticky; /* ‡∏ï‡∏£‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
        top: 0;
        z-index: 10;
      }
      .menu-item {
        padding: 15px 25px;
        border-bottom: 1px solid #34495e;
        cursor: pointer;
        color: #ecf0f1;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .menu-item:hover {
        background: #34495e;
        padding-left: 30px;
      }
      .menu-item.active {
        background: #3498db;
        color: white;
        border-left: 5px solid #2980b9;
      }

      /* Main Content */
      .content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        overflow-x: hidden;
      }
      .section-view {
        display: none;
        animation: slideUp 0.3s ease-out;
      }
      .section-view.active {
        display: block;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- UI Components --- */
      .card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }
      .center-container {
        max-width: 800px;
        margin: 0 auto;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.8em;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        display: inline-block;
      }

      /* Forms */
      .form-group {
        margin-bottom: 20px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
      }
      .form-row > div {
        flex: 1;
        min-width: 200px; /* ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πâ‡∏≤‡∏á 200px */
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: 0.2s;
        font-family: "Sarabun", sans-serif;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      }

      /* Buttons */
      button {
        font-family: "Sarabun", sans-serif;
        font-size: 1em;
        cursor: pointer;
        transition: 0.2s;
        white-space: nowrap; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
      }
      .btn-main {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
      }
      .btn-main:hover {
        background: #2980b9;
      }

      .btn-success {
        background: #2ecc71;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
      }
      .btn-success:hover {
        background: #27ae60;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
      }
      .btn-danger:hover {
        background: #c0392b;
      }

      /* Table Style */
      .table-container {
        border-radius: 12px;
        overflow-x: auto; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        background: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
      }
      th {
        background: #34495e;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 500;
        white-space: nowrap;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        color: #555;
        vertical-align: middle;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: #f8f9fa;
      }

      /* Action Buttons Group (‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á) */
      .action-group {
        display: flex;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
      }

      .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: 0.2s;
        /* margin-right: 5px;  <- ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ gap ‡πÉ‡∏ô flex ‡πÅ‡∏•‡πâ‡∏ß */
      }
      .btn-edit {
        background-color: #ffc107;
        color: #212529;
      }
      .btn-edit:hover {
        background-color: #e0a800;
      }

      .btn-delete {
        background-color: #dc3545;
        color: white;
      }
      .btn-delete:hover {
        background-color: #c82333;
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 2000; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Layer ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
        backdrop-filter: blur(2px);
      }
      .modal-content {
        background: white;
        padding: 30px;
        width: 450px;
        max-width: 90%; /* ‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏ô‡∏à‡∏≠‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå */
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
      }
      @keyframes popIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .modal-buttons {
        text-align: right;
        margin-top: 20px;
      }
      .btn-confirm {
        background: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-cancel {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }

      /* Success Popup */
      #success-modal .modal-content {
        text-align: center;
        width: 300px;
      }
      .success-icon {
        font-size: 4em;
        color: #2ecc71;
        margin-bottom: 10px;
      }

      /* --- Barcode Print Styles --- */
      #barcode-print-area {
        display: none;
      } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */

      @media print {
        body.printing-barcode * {
          visibility: hidden;
        }

        body.printing-barcode #barcode-print-area {
          visibility: visible;
          display: flex !important;
          justify-content: center;
          align-items: center;

          position: fixed;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: white;
          z-index: 9999;
        }

        body.printing-barcode #barcode-print-area * {
          visibility: visible;
        }

        @page {
          margin: 0;
          size: auto;
        }
      }

      /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πá‡∏ö (Tab) ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ */
      .settings-nav {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 25px;
      }
      .settings-tab-btn {
        padding: 15px 30px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        color: #95a5a6;
        background: transparent;
        border: none;
        border-bottom: 4px solid transparent;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .settings-tab-btn:hover {
        color: #34495e;
        background: #f8f9fa;
      }
      .settings-tab-btn.active {
        color: #3498db;
        border-bottom: 4px solid #3498db;
      }

      /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
      .tab-content-area {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-content-area.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>üõçÔ∏è POS Admin</h2>
      <div class="menu-item active" onclick="switchTab('dashboard', this)">
        <span>üìä</span> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
      </div>
      <div class="menu-item" onclick="switchTab('stock', this)">
        <span>üì¶</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      </div>
      <div class="menu-item" onclick="switchTab('categories', this)">
        <span>üìÇ</span> ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      </div>
      <div class="menu-item" onclick="switchTab('purchase', this)">
        <span>üì•</span> ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
      </div>
      <div class="menu-item" onclick="switchTab('suppliers', this)">
        <span>üöö</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤
      </div>
      <div class="menu-item" onclick="switchTab('report', this)">
        <span>üìà</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      </div>
      <div class="menu-item" onclick="switchTab('users', this)">
        <span>üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      </div>
      <div class="menu-item" onclick="switchTab('members', this)">
        <span>üëë</span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      </div>
      <div class="menu-item" onclick="switchTab('settings', this)">
        <span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
      </div>

      <a
        href="/"
        class="menu-item"
        target="_blank"
        style="margin-top: auto; background: #1abc9c"
        ><span>üíª</span> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á</a
      >
      <div
        class="menu-item"
        onclick="openLogoutModal()"
        style="background: #c0392b; margin-top: 10px"
      >
        <span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </div>
    </div>

    <div class="content">
      <div id="view-dashboard" class="section-view active">
        <h1>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h1>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
          "
        >
          <div
            class="card"
            style="
              border-left: 5px solid #2ecc71;
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <div style="color: #7f8c8d">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div
                style="font-size: 2em; font-weight: bold; color: #2c3e50"
                id="today-sales"
              >
                0.00
              </div>
            </div>
            <div style="font-size: 3em; color: #2ecc71">üí∞</div>
          </div>
          <div
            class="card"
            style="
              border-left: 5px solid #3498db;
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <div style="color: #7f8c8d">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div
                style="font-size: 2em; font-weight: bold; color: #2c3e50"
                id="today-bills"
              >
                0
              </div>
            </div>
            <div style="font-size: 3em; color: #3498db">üßæ</div>
          </div>
        </div>
        <div
          style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap"
        >
          <div class="card" style="flex: 2; min-width: 300px">
            <h3 style="margin-top: 0; color: #555">üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
            <div style="height: 300px">
              <canvas id="salesChart"></canvas>
            </div>
          </div>

          <div class="card" style="flex: 1; min-width: 300px">
            <h3 style="margin-top: 0; color: #555">üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
            <div style="height: 300px">
              <canvas id="topProductsChart"></canvas>
            </div>
          </div>
        </div>
        <h2 style="color: #555">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</th>
              </tr>
            </thead>
            <tbody id="order-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-stock" class="section-view">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
          <div>
            <input
              type="file"
              id="import-file"
              accept=".xlsx, .xls"
              style="display: none"
              onchange="uploadExcel(this)"
            />
            <button
              onclick="document.getElementById('import-file').click()"
              class="btn-main"
              style="background: #27ae60; margin-right: 10px"
            >
              üìÑ Import Excel
            </button>

            <button
              onclick="openEditModal()"
              class="btn-success"
              style="margin-right: 10px"
            >
              + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            </button>
            <button onclick="loadStock()" class="btn-main">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Barcode</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</th>
                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th width="280">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="stock-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-categories" class="section-view">
        <h1>üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <div class="card">
          <div class="form-row" style="align-items: flex-end">
            <div style="flex: 3">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</label
              ><input
                type="text"
                id="cat-new-name"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°, ‡∏Ç‡∏ô‡∏°‡∏Ç‡∏ö‡πÄ‡∏Ñ‡∏µ‡πâ‡∏¢‡∏ß"
              />
            </div>
            <div style="flex: 1">
              <button
                onclick="addCategory()"
                class="btn-success"
                style="width: 100%"
              >
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°
              </button>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                <th width="100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="category-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-purchase" class="section-view">
        <h1>‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</h1>
        <div class="card">
          <div class="form-row" style="align-items: flex-end">
            <div style="flex: 1">
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (Supplier)</label
              ><select id="po-supplier">
                <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î --</option>
              </select>
            </div>
            <div style="flex: 2">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Barcode / ‡∏ä‡∏∑‡πà‡∏≠)</label>
              <div style="display: flex; gap: 10px">
                <input
                  type="text"
                  id="po-search"
                  placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..."
                /><button onclick="searchProductForPO()" class="btn-main">
                  üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="padding: 0; overflow: hidden">
          <table style="margin: 0">
            <thead>
              <tr style="background: #ecf0f1; color: #333">
                <th style="padding: 15px">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th width="150" style="padding: 15px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                <th width="150" style="padding: 15px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö</th>
                <th width="150" style="padding: 15px; text-align: right">
                  ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                </th>
                <th width="80" style="padding: 15px">‡∏•‡∏ö</th>
              </tr>
            </thead>
            <tbody id="po-table"></tbody>
            <tfoot>
              <tr style="background: #2c3e50; color: white">
                <td
                  colspan="3"
                  style="text-align: right; padding: 20px; font-weight: bold"
                >
                  ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                </td>
                <td
                  style="
                    text-align: right;
                    padding: 20px;
                    font-size: 1.5em;
                    font-weight: bold;
                    color: #2ecc71;
                  "
                  id="po-total"
                >
                  0.00
                </td>
                <td style="padding: 20px">‡∏ö‡∏≤‡∏ó</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="text-align: right; margin-top: 20px">
          <button
            onclick="savePurchase()"
            class="btn-success"
            style="padding: 15px 40px; font-size: 1.2em"
          >
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
          </button>
        </div>
      </div>

      <div id="view-suppliers" class="section-view">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤</h1>
          <button onclick="openSupplierModal()" class="btn-success">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                <th>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                <th width="150">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="supplier-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-report" class="section-view">
        <h1>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
        <div class="card">
          <div class="form-row" style="align-items: flex-end">
            <div>
              <label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rep-start" />
            </div>
            <div>
              <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rep-end" />
            </div>
            <div style="display: flex; gap: 10px">
              <button onclick="loadReport()" class="btn-main" style="flex: 1">
                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
              <button
                onclick="exportReport()"
                class="btn-success"
                style="flex: 1; background-color: #27ae60"
              >
                üìÑ Export Excel
              </button>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 20px; margin-bottom: 20px">
          <div
            class="card"
            style="
              flex: 1;
              text-align: center;
              border-left: 5px solid #2ecc71;
              margin-bottom: 0;
            "
          >
            <div style="color: #7f8c8d">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
            <div
              style="font-size: 2.5em; font-weight: bold; color: #2c3e50"
              id="rep-total-sales"
            >
              0.00
            </div>
            <div style="color: #2ecc71; font-weight: bold">‡∏ö‡∏≤‡∏ó</div>
          </div>
          <div
            class="card"
            style="
              flex: 1;
              text-align: center;
              border-left: 5px solid #3498db;
              margin-bottom: 0;
            "
          >
            <div style="color: #7f8c8d">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
            <div
              style="font-size: 2.5em; font-weight: bold; color: #2c3e50"
              id="rep-total-bills"
            >
              0
            </div>
            <div style="color: #3498db; font-weight: bold">‡πÉ‡∏ö</div>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</th>
              </tr>
            </thead>
            <tbody id="report-table">
              <tr>
                <td colspan="5" style="text-align: center">
                  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="view-users" class="section-view">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
          <button onclick="openUserModal()" class="btn-success">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                <th width="150">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="user-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-members" class="section-view">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>üëë ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (CRM)</h1>
          <div>
            <button
              onclick="openMemberModal()"
              class="btn-success"
              style="margin-right: 10px"
            >
              + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
            </button>
            <button onclick="loadMembers()" class="btn-main">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
        </div>
        <div class="card" style="padding: 15px">
          <input
            type="text"
            id="search-member"
            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..."
            onkeyup="filterMembers()"
            style="width: 100%"
          />
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                <th>‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                <th width="150">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="member-table"></tbody>
          </table>
        </div>
      </div>

      <div id="view-settings" class="section-view">
        <div class="center-container">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h1>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
            <button
              onclick="saveSettings()"
              class="btn-success"
              style="
                padding: 10px 25px;
                font-size: 1em;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              "
            >
              üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>

          <div class="settings-nav">
            <button
              class="settings-tab-btn active"
              onclick="openSubTab('tab-system', this)"
            >
              üè† ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <button
              class="settings-tab-btn"
              onclick="openSubTab('tab-device', this)"
            >
              üñ®Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </button>
          </div>

          <div class="card" style="min-height: 500px">
            <div id="tab-system" class="tab-content-area active">
              <h3
                style="
                  color: #2c3e50;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 15px;
                  margin-top: 0;
                "
              >
                üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏£‡∏∞‡∏ö‡∏ö
              </h3>

              <div class="form-row">
                <div>
                  <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="set-name" />
                </div>
                <div>
                  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label
                  ><input type="text" id="set-phone" />
                </div>
              </div>

              <div class="form-group">
                <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô</label
                ><textarea id="set-address" rows="3"></textarea>
              </div>

              <div class="form-row">
                <div>
                  <label>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label
                  ><input type="text" id="set-tax" />
                </div>
                <div>
                  <label>VAT (%)</label><input type="number" id="set-vat" />
                </div>
              </div>

              <div class="form-group">
                <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏° (‡∏ö‡∏≤‡∏ó/‡πÅ‡∏ï‡πâ‡∏°)</label>
                <input type="number" id="set-points-ratio" placeholder="10" />
              </div>

              <div class="form-group">
                <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label
                ><input type="text" id="set-footer" />
              </div>

              <h4 style="margin-top: 30px; color: #555">
                üí∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô & ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              </h4>
              <div
                style="
                  background: #f8f9fa;
                  padding: 20px;
                  border-radius: 8px;
                  border: 1px dashed #ccc;
                "
              >
                <div class="form-group">
                  <label style="color: #0056b3">üì≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (QR Code)</label>
                  <input
                    type="text"
                    id="set-promptpay"
                    placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£/‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£"
                  />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label style="color: #1e7e34">üí¨ LINE Token</label>
                  <input
                    type="password"
                    id="set-line-token"
                    placeholder="Token"
                  />
                </div>
              </div>

              <h4
                style="
                  margin-top: 30px;
                  color: #555;
                  border-top: 1px solid #eee;
                  padding-top: 20px;
                "
              >
                üíæ ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Maintenance)
              </h4>
              <div
                style="
                  background: #fdf2f2;
                  padding: 20px;
                  border-radius: 8px;
                  border: 1px dashed #e74c3c;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <div>
                  <div style="font-weight: bold; color: #c0392b">
                    ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup Database)
                  </div>
                  <div style="font-size: 0.9em; color: #7f8c8d">
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô)
                  </div>
                </div>
                <button
                  onclick="backupDatabase()"
                  class="btn-main"
                  style="background: #c0392b"
                >
                  ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Backup
                </button>
              </div>
            </div>

            <div id="tab-device" class="tab-content-area">
              <h3
                style="
                  color: #2c3e50;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 15px;
                  margin-top: 0;
                "
              >
                üñ®Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå Hardware
              </h3>

              <div class="mb-3" style="max-width: 500px">
                <label class="fw-bold text-primary" style="font-size: 1.1em"
                  >‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label
                >
                <select
                  id="set-printer"
                  style="
                    width: 100%;
                    padding: 15px;
                    font-size: 1.1em;
                    border: 2px solid #3498db;
                    border-radius: 8px;
                    margin-top: 10px;
                    background: white;
                  "
                >
                  <option value="a4">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                  <option value="58mm">‡∏™‡∏•‡∏¥‡∏õ 58mm (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å/‡∏û‡∏Å‡∏û‡∏≤)</option>
                  <option value="80mm">‡∏™‡∏•‡∏¥‡∏õ 80mm (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)</option>
                </select>
              </div>

              <div
                style="
                  margin-top: 30px;
                  padding: 20px;
                  background: #e3f2fd;
                  border-radius: 8px;
                  border-left: 5px solid #2196f3;
                "
              >
                <label style="font-weight: bold; color: #0d47a1"
                  >‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î:</label
                >
                <ul style="color: #444; margin-top: 10px; padding-left: 20px">
                  <li>
                    <b>58mm:</b> ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Bluetooth
                    ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏µ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å
                  </li>
                  <li>
                    <b>80mm:</b> ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Epson, Xprinter
                    ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
                  </li>
                  <li><b>A4:</b> ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <input type="hidden" id="edit-id" />
        <div class="form-group">
          <label>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Barcode)</label
          ><input
            type="text"
            id="edit-barcode"
            placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
          />
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="edit-name" />
        </div>
        <div class="form-group">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <select
            id="edit-category"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #ddd;
              border-radius: 8px;
            "
          >
            <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
          </select>
        </div>
        <div class="form-row">
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</label><input type="number" id="edit-cost" />
          </div>
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input type="number" id="edit-price" />
          </div>
        </div>
        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</label
          ><input type="number" id="edit-stock" style="background: #f9f9f9" />
        </div>
        <div class="modal-buttons">
          <button onclick="saveEdit()" class="btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button
            onclick="document.getElementById('edit-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="supplier-modal" class="modal-overlay">
      <div class="modal-content">
        <h3>üöö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤</h3>
        <input type="hidden" id="sup-id" />
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label><input type="text" id="sup-name" />
        </div>
        <div class="form-group">
          <label>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><input type="text" id="sup-contact" />
        </div>
        <div class="form-group">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="sup-phone" />
        </div>
        <div class="form-group">
          <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input type="text" id="sup-address" />
        </div>
        <div class="modal-buttons">
          <button onclick="saveSupplier()" class="btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button
            onclick="document.getElementById('supplier-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="user-modal" class="modal-overlay">
      <div class="modal-content">
        <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
        <input type="hidden" id="u-id" />
        <div class="form-group">
          <label>Username</label><input type="text" id="u-user" />
        </div>
        <div class="form-group">
          <label>Password (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label
          ><input type="password" id="u-pass" placeholder="****" />
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="u-name" />
        </div>
        <div class="form-group">
          <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
          <select id="u-role">
            <option value="cashier">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (Cashier)</option>
            <option value="admin">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Admin)</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button onclick="saveUser()" class="btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button
            onclick="document.getElementById('user-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="member-modal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="mem-modal-title">üëë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <input type="hidden" id="mem-id" />
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="mem-name" />
        </div>
        <div class="form-group">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="text" id="mem-phone" />
        </div>
        <div class="form-group">
          <label>‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</label
          ><input
            type="number"
            id="mem-points"
            style="background: #e3f2fd; font-weight: bold; color: #007bff"
          />
        </div>
        <div class="modal-buttons">
          <button onclick="saveMember()" class="btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button
            onclick="document.getElementById('member-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
      <div class="modal-content" style="text-align: center">
        <div style="font-size: 3em; margin-bottom: 10px">‚ö†Ô∏è</div>
        <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?</h3>
        <p id="delete-msg" style="color: #666">
          ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
        </p>
        <div class="modal-buttons" style="text-align: center">
          <button onclick="confirmDelete()" class="btn-confirm">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
          </button>
          <button onclick="closeDeleteModal()" class="btn-cancel">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="not-found-modal" class="modal-overlay">
      <div class="modal-content" style="text-align: center; width: 400px">
        <div style="font-size: 4em; margin-bottom: 10px">üì¶‚ùì</div>
        <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <p style="font-size: 1.1em">
          ‡∏£‡∏´‡∏±‡∏™:
          <span
            id="nf-barcode"
            style="color: #3498db; font-weight: bold"
          ></span>
        </p>
        <p style="color: #666; margin-bottom: 25px">
          ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
        </p>
        <div class="modal-buttons" style="justify-content: center">
          <button
            onclick="proceedToAddNew()"
            class="btn-success"
            style="font-size: 1.1em"
          >
            ‚úÖ ‡πÉ‡∏ä‡πà, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
          </button>
          <button
            onclick="document.getElementById('not-found-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="success-modal" class="modal-overlay">
      <div class="modal-content" style="text-align: center; width: 300px">
        <div class="success-icon">‚úÖ</div>
        <h3 id="success-msg">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <button
          onclick="document.getElementById('success-modal').style.display='none'"
          class="btn-main"
          style="width: 100%; margin-top: 20px"
        >
          ‡∏ï‡∏Å‡∏•‡∏á
        </button>
      </div>
    </div>

    <div id="logout-modal" class="modal-overlay">
      <div class="modal-content" style="text-align: center; width: 350px">
        <div style="font-size: 3em; margin-bottom: 10px">üö™</div>
        <h3 style="margin-top: 0">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?</h3>
        <p style="color: #666; margin-bottom: 25px">
          ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
        </p>
        <div class="modal-buttons" style="justify-content: center">
          <button
            onclick="confirmLogout()"
            class="btn-confirm"
            style="margin-right: 10px"
          >
            ‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
          </button>
          <button onclick="closeLogoutModal()" class="btn-cancel">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>
    </div>

    <div id="history-modal" class="modal-overlay">
      <div class="modal-content" style="width: 700px; max-width: 95%">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (Stock Card)</h3>
          <button
            onclick="document.getElementById('history-modal').style.display='none'"
            class="btn-cancel"
            style="padding: 5px 10px"
          >
            ‚ùå ‡∏õ‡∏¥‡∏î
          </button>
        </div>
        <h4 id="hist-product-name" style="color: #007bff; margin-top: 0"></h4>

        <div
          class="table-container"
          style="max-height: 400px; overflow-y: auto"
        >
          <table>
            <thead>
              <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                <th>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              </tr>
            </thead>
            <tbody id="history-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="barcode-modal" class="modal-overlay">
      <div class="modal-content" style="width: 400px; text-align: center">
        <h3 style="margin-top: 0">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

        <div
          style="
            border: 1px dashed #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
          "
        >
          <svg id="barcode-preview"></svg>
          <div
            id="barcode-name"
            style="margin-top: 5px; font-weight: bold"
          ></div>
          <div id="barcode-price" style="color: green"></div>
        </div>

        <div class="modal-buttons" style="justify-content: center">
          <button
            onclick="printBarcode()"
            class="btn-main"
            style="margin-right: 10px"
          >
            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
          </button>
          <button
            onclick="document.getElementById('barcode-modal').style.display='none'"
            class="btn-cancel"
          >
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
      </div>
    </div>

    <div id="barcode-print-area">
      <div
        style="
          text-align: center;
          border: 1px solid #ddd;
          padding: 10px;
          width: 5cm;
          height: 3cm;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        "
      >
        <div
          id="p-name"
          style="
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            max-width: 100%;
          "
        >
          ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </div>
        <svg id="p-barcode"></svg>
        <div id="p-price" style="font-size: 16px; font-weight: bold">‡∏£‡∏≤‡∏Ñ‡∏≤</div>
      </div>
    </div>

    <script>
      let deleteTargetId = null;
      let deleteType = null;
      let poCart = [];
      let allSuppliers = [];
      let allMembers = [];

      // --- Core ---
      function switchTab(tabName, btnElement) {
        // ‡∏•‡πâ‡∏≤‡∏á class active ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        document
          .querySelectorAll(".section-view")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".sidebar .menu-item")
          .forEach((el) => el.classList.remove("active"));

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        const targetView = document.getElementById("view-" + tabName);
        if (targetView) targetView.classList.add("active");

        if (btnElement) btnElement.classList.add("active");

        // Logic ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (tabName === "dashboard") loadDashboardData();
        else if (tabName === "stock") loadStock();
        else if (tabName === "categories") loadCategories();
        else if (tabName === "suppliers") loadSuppliers();
        else if (tabName === "users") loadUsers();
        else if (tabName === "purchase") loadPurchaseScreen();
        else if (tabName === "report") initReport();
        else if (tabName === "members") loadMembers();
        else if (tabName === "settings") loadSettings();
      }

      function showSuccess(msg) {
        document.getElementById("success-msg").innerText = msg;
        document.getElementById("success-modal").style.display = "flex";
        setTimeout(
          () =>
            (document.getElementById("success-modal").style.display = "none"),
          1500
        );
      }

      function openDeleteModal(id, type, name) {
        deleteTargetId = id;
        deleteType = type;
        document.getElementById(
          "delete-msg"
        ).innerText = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
        document.getElementById("delete-modal").style.display = "flex";
      }
      function closeDeleteModal() {
        document.getElementById("delete-modal").style.display = "none";
        deleteTargetId = null;
      }

      async function confirmDelete() {
        if (!deleteTargetId) return;
        let url = "";
        if (deleteType === "product") url = "/products/" + deleteTargetId;
        else if (deleteType === "category")
          url = "/categories/" + deleteTargetId;
        else if (deleteType === "supplier")
          url = "/suppliers/" + deleteTargetId;
        else if (deleteType === "user") url = "/users/" + deleteTargetId;
        else if (deleteType === "member") url = "/members/" + deleteTargetId;

        try {
          const res = await fetch(url, { method: "DELETE" });
          if (res.ok) {
            closeDeleteModal();
            showSuccess("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            if (deleteType === "product") loadStock();
            else if (deleteType === "category") loadCategories();
            else if (deleteType === "supplier") loadSuppliers();
            else if (deleteType === "user") loadUsers();
            else if (deleteType === "member") loadMembers();
          } else {
            alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          }
        } catch (e) {
          console.error(e);
          alert("Error");
        }
      }

      // --- Dashboard ---
      document.addEventListener("DOMContentLoaded", () => loadDashboardData());
      async function loadCharts() {
        try {
          const res = await fetch("/admin/chart-data");
          const data = await res.json();

          // ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô
          const ctxSales = document
            .getElementById("salesChart")
            .getContext("2d");
          if (window.mySalesChart) window.mySalesChart.destroy();

          window.mySalesChart = new Chart(ctxSales, {
            type: "bar",
            data: {
              labels: data.sales.map((d) => d.date),
              datasets: [
                {
                  label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
                  data: data.sales.map((d) => d.total),
                  backgroundColor: "#3498db",
                  borderRadius: 5,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } },
            },
          });

          // ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ
          const ctxTop = document
            .getElementById("topProductsChart")
            .getContext("2d");
          if (window.myTopChart) window.myTopChart.destroy();

          window.myTopChart = new Chart(ctxTop, {
            type: "doughnut",
            data: {
              labels: data.topProducts.map((p) => p.product_name),
              datasets: [
                {
                  data: data.topProducts.map((p) => p.total_qty),
                  backgroundColor: [
                    "#e74c3c",
                    "#f1c40f",
                    "#2ecc71",
                    "#9b59b6",
                    "#34495e",
                  ],
                },
              ],
            },
            options: { responsive: true, maintainAspectRatio: false },
          });
        } catch (e) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
        }
      }

      async function loadDashboardData(isAutoRefresh = false) {
        try {
          const res = await fetch("/admin/summary");
          const data = await res.json();
          document.getElementById("today-sales").innerText = parseFloat(
            data.total_sales || 0
          ).toLocaleString("th-TH", { minimumFractionDigits: 2 });
          document.getElementById("today-bills").innerText =
            data.total_bills || 0;

          const resOrd = await fetch("/admin/orders");
          const orders = await resOrd.json();
          const tbody = document.getElementById("order-table");
          tbody.innerHTML = "";
          orders.forEach((order) => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${order.receipt_no}</td><td>${new Date(
              order.sale_date
            ).toLocaleTimeString(
              "th-TH"
            )}</td><td style="color:#27ae60; font-weight:bold;">${parseFloat(
              order.total_amount
            ).toFixed(
              2
            )}</td><td><span style="background:#ecf0f1; padding:2px 8px; border-radius:4px;">${
              order.payment_method
            }</span></td>`;
            tbody.appendChild(row);
          });

          if (!isAutoRefresh) {
            loadCharts();
          }
        } catch (e) {
          console.error(e);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadDashboardData();

        setInterval(() => {
          const dashboardTab = document.getElementById("view-dashboard");
          if (dashboardTab && dashboardTab.classList.contains("active")) {
            loadDashboardData(true);
          }
        }, 3000);

        const poSearchInput = document.getElementById("po-search");
        if (poSearchInput) {
          poSearchInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
              event.preventDefault();
              searchProductForPO();
            }
          });
        }
      });

      // --- Categories ---
      async function loadCategories() {
        const res = await fetch("/categories");
        const cats = await res.json();

        const tbody = document.getElementById("category-table");
        if (tbody) {
          tbody.innerHTML = "";
          cats.forEach(
            (c) =>
              (tbody.innerHTML += `<tr><td>${c.name}</td><td><button class="btn-action btn-delete" onclick="openDeleteModal(${c.id}, 'category', '${c.name}')">‡∏•‡∏ö</button></td></tr>`)
          );
        }
        const select = document.getElementById("edit-category");
        if (select) {
          select.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>';
          cats.forEach(
            (c) =>
              (select.innerHTML += `<option value="${c.id}">${c.name}</option>`)
          );
        }
      }
      async function addCategory() {
        const name = document.getElementById("cat-new-name").value;
        if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà");
        await fetch("/categories", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name }),
        });
        document.getElementById("cat-new-name").value = "";
        loadCategories();
        showSuccess("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      }

      // --- Stock ---
      async function loadStock() {
        await loadCategories();
        const res = await fetch("/products");
        const products = await res.json();
        const tbody = document.getElementById("stock-table");
        tbody.innerHTML = "";

        products.forEach((p) => {
          const row = document.createElement("tr");

          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å
          const stockStyle =
            p.stock_qty < 10 ? "color:red;font-weight:bold;" : "color:green;";

          row.innerHTML = `
            <td>${p.barcode}</td>
            <td>
                <b>${p.name}</b><br>
                <small style="color:#888;">${
                  p.category_name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                }</small>
            </td>
            <td>${p.cost_price}</td>
            <td>${p.selling_price}</td>
            <td style="${stockStyle}">${p.stock_qty}</td>
            <td>
                <div class="action-group">
                    
                    <button class="btn-action" style="background:#6c757d; color:white;" 
                            onclick="openBarcodeModal('${p.barcode}', '${
            p.name
          }', ${p.selling_price})" 
                            title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
                        üñ®Ô∏è </button>

                    <button class="btn-action" style="background:#17a2b8; color:white;" 
                            onclick="viewStockHistory(${p.id}, '${p.name}')">
                        üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    </button>
                    
                    <button class="btn-action btn-edit" onclick='openEditModal(${JSON.stringify(
                      p
                    )})'>
                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button> 
                    
                    <button class="btn-action btn-delete" onclick="openDeleteModal(${
                      p.id
                    }, 'product', '${p.name}')">
                        üóëÔ∏è ‡∏•‡∏ö
                    </button>

                </div>
            </td>`;

          tbody.appendChild(row);
        });
      }
      function openEditModal(p = null) {
        document.getElementById("edit-modal").style.display = "flex";
        if (p) {
          document.getElementById("modal-title").innerText =
            "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
          document.getElementById("edit-id").value = p.id;
          document.getElementById("edit-barcode").value = p.barcode;
          document.getElementById("edit-barcode").disabled = true;
          document.getElementById("edit-barcode").style.background = "#eee";
          document.getElementById("edit-name").value = p.name;
          document.getElementById("edit-cost").value = p.cost_price;
          document.getElementById("edit-price").value = p.selling_price;
          document.getElementById("edit-stock").value = p.stock_qty;
          document.getElementById("edit-category").value = p.category_id || "";
        } else {
          document.getElementById("modal-title").innerText =
            "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà";
          document.getElementById("edit-id").value = "";
          document.getElementById("edit-barcode").value = "";
          document.getElementById("edit-barcode").disabled = false;
          document.getElementById("edit-barcode").style.background = "white";
          document.getElementById("edit-name").value = "";
          document.getElementById("edit-cost").value = "";
          document.getElementById("edit-price").value = "";
          document.getElementById("edit-stock").value = "0";
          document.getElementById("edit-category").value = "";
        }
      }
      async function saveEdit() {
        const id = document.getElementById("edit-id").value;
        const body = {
          barcode: document.getElementById("edit-barcode").value,
          name: document.getElementById("edit-name").value,
          cost: document.getElementById("edit-cost").value,
          price: document.getElementById("edit-price").value,
          stock: document.getElementById("edit-stock").value,
          category_id: document.getElementById("edit-category").value,
        };
        if (!body.name || !body.price || !body.barcode)
          return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        const method = id ? "PUT" : "POST";
        const url = id ? "/products/" + id : "/products";

        try {
          const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (res.ok) {
            document.getElementById("edit-modal").style.display = "none";
            showSuccess(id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loadStock();
          } else {
            alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥)");
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- Settings ---
      async function loadSettings() {
        const res = await fetch("/settings");
        const data = await res.json();
        document.getElementById("set-printer").value =
          data.printer_type || "a4";
        document.getElementById("set-name").value = data.shop_name || "";
        document.getElementById("set-phone").value = data.phone || "";
        document.getElementById("set-address").value = data.shop_address || "";
        document.getElementById("set-tax").value = data.tax_id || "";
        document.getElementById("set-vat").value = data.vat_rate || 0;
        document.getElementById("set-footer").value = data.receipt_footer || "";
        document.getElementById("set-line-token").value = data.line_token || "";
        document.getElementById("set-points-ratio").value =
          data.points_ratio || 10;

        if (document.getElementById("set-promptpay")) {
          document.getElementById("set-promptpay").value =
            data.promptpay_id || "";
        }
      }
      async function saveSettings() {
        const body = {
          shop_name: document.getElementById("set-name").value,
          phone: document.getElementById("set-phone").value,
          shop_address: document.getElementById("set-address").value,
          tax_id: document.getElementById("set-tax").value,
          vat_rate: document.getElementById("set-vat").value,
          receipt_footer: document.getElementById("set-footer").value,
          line_token: document.getElementById("set-line-token").value,
          points_ratio: document.getElementById("set-points-ratio").value,
          promptpay_id: document.getElementById("set-promptpay").value,
          printer_type: document.getElementById("set-printer").value,
        };
        await fetch("/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        showSuccess("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      }

      // --- Suppliers ---
      async function loadSuppliers() {
        const res = await fetch("/suppliers");
        const data = await res.json();
        const tbody = document.getElementById("supplier-table");
        tbody.innerHTML = "";
        data.forEach((s) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${s.name}</td><td>${
            s.contact_name || "-"
          }</td><td>${s.phone || "-"}</td><td>${s.address || "-"}</td>
                <td><button class="btn-action btn-edit" onclick='openSupplierModal(${JSON.stringify(
                  s
                )})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> <button class="btn-action btn-delete" onclick="openDeleteModal(${
            s.id
          }, 'supplier', '${s.name}')">‡∏•‡∏ö</button></td>`;
          tbody.appendChild(row);
        });
      }
      function openSupplierModal(data = null) {
        document.getElementById("supplier-modal").style.display = "flex";
        if (data) {
          document.getElementById("sup-id").value = data.id;
          document.getElementById("sup-name").value = data.name;
          document.getElementById("sup-contact").value = data.contact_name;
          document.getElementById("sup-phone").value = data.phone;
          document.getElementById("sup-address").value = data.address;
        } else {
          document.getElementById("sup-id").value = "";
          document.getElementById("sup-name").value = "";
          document.getElementById("sup-contact").value = "";
          document.getElementById("sup-phone").value = "";
          document.getElementById("sup-address").value = "";
        }
      }
      async function saveSupplier() {
        const id = document.getElementById("sup-id").value;
        const body = {
          name: document.getElementById("sup-name").value,
          contact: document.getElementById("sup-contact").value,
          phone: document.getElementById("sup-phone").value,
          address: document.getElementById("sup-address").value,
        };
        const method = id ? "PUT" : "POST";
        const url = id ? "/suppliers/" + id : "/suppliers";
        await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        document.getElementById("supplier-modal").style.display = "none";
        showSuccess("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadSuppliers();
      }

      // --- Purchase ---
      async function loadPurchaseScreen() {
        const res = await fetch("/suppliers");
        allSuppliers = await res.json();
        const select = document.getElementById("po-supplier");
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ --</option>';
        allSuppliers.forEach(
          (s) =>
            (select.innerHTML += `<option value="${s.id}">${s.name}</option>`)
        );
        poCart = [];
        updatePOTable();
        document.getElementById("po-search").value = "";
      }
      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
      let tempBarcode = "";

      async function searchProductForPO() {
        const keyword = document.getElementById("po-search").value.trim();
        if (!keyword) return;

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const res = await fetch("/products");
        const products = await res.json();

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const found =
          products.find((p) => p.barcode === keyword) ||
          products.find((p) => p.name.includes(keyword));

        if (found) {
          addToPOCart(found);
          document.getElementById("po-search").value = "";
        } else {
          tempBarcode = keyword;
          document.getElementById("nf-barcode").innerText = keyword;
          document.getElementById("not-found-modal").style.display = "flex";

          document.getElementById("po-search").value = "";
        }
      }

      function proceedToAddNew() {
        document.getElementById("not-found-modal").style.display = "none";

        openEditModal();

        document.getElementById("edit-barcode").value = tempBarcode;

        document.getElementById("modal-title").innerText =
          "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏î‡πà‡∏ß‡∏ô)";
      }

      function addToPOCart(p) {
        const exist = poCart.find((i) => i.id === p.id);
        if (exist) exist.qty++;
        else
          poCart.push({
            id: p.id,
            name: p.name,
            barcode: p.barcode,
            price: p.selling_price,
            cost: parseFloat(p.cost_price),
            qty: 1,
          });
        updatePOTable();
      }
      function updatePOTable() {
        const tbody = document.getElementById("po-table");
        tbody.innerHTML = "";
        let total = 0;
        poCart.forEach((item, index) => {
          const lineTotal = (item.cost || 0) * (item.qty || 0);
          total += lineTotal;
          const row = document.createElement("tr");
          row.innerHTML = `<td><div style="font-weight:bold;">${
            item.name
          }</div><div style="font-size:0.85em; color:#666;">‡∏£‡∏´‡∏±‡∏™: <span style="color:#007bff;">${
            item.barcode || "-"
          }</span> | ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô: <b>${item.price || 0}</b> ‡∏ö‡∏≤‡∏ó</div></td>
                <td><input type="number" value="${
                  item.cost
                }" onchange="updatePOItem(${index}, 'cost', this.value)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; text-align:right;"></td>
                <td><input type="number" value="${
                  item.qty
                }" onchange="updatePOItem(${index}, 'qty', this.value)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; text-align:center;"></td>
                <td style="text-align:right; font-weight:bold; color:#2ecc71;">${lineTotal.toLocaleString(
                  "th-TH",
                  { minimumFractionDigits: 2 }
                )}</td>
                <td><button class="btn-action btn-delete" onclick="removePOItem(${index})">‚ùå</button></td>`;
          tbody.appendChild(row);
        });
        document.getElementById("po-total").innerText = total.toLocaleString(
          "th-TH",
          { minimumFractionDigits: 2 }
        );
      }
      function updatePOItem(idx, f, v) {
        const val = parseFloat(v) || 0;
        if (f === "qty" && val < 1) return;
        poCart[idx][f] = val;
        updatePOTable();
      }
      function removePOItem(idx) {
        poCart.splice(idx, 1);
        updatePOTable();
      }
      async function savePurchase() {
        const supplierId = document.getElementById("po-supplier").value;
        if (!supplierId || poCart.length === 0) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á?")) return;
        const total = parseFloat(
          document.getElementById("po-total").innerText.replace(/,/g, "")
        );
        await fetch("/purchase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            supplier_id: supplierId,
            items: poCart,
            total_cost: total,
          }),
        });
        showSuccess("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        loadPurchaseScreen();
      }

      // --- Users ---
      async function loadUsers() {
        try {
          const res = await fetch("/users");
          const users = await res.json();
          const tbody = document.getElementById("user-table");
          tbody.innerHTML = "";
          users.forEach((u) => {
            const roleBadge =
              u.role === "admin"
                ? '<span style="background:#e74c3c; color:white; padding:4px 8px; border-radius:4px; font-size:0.8em;">Admin</span>'
                : '<span style="background:#3498db; color:white; padding:4px 8px; border-radius:4px; font-size:0.8em;">Cashier</span>';
            const row = document.createElement("tr");
            const btnActions =
              u.username !== "admin"
                ? `<button class="btn-action btn-edit" onclick='openUserModal(${JSON.stringify(
                    u
                  )})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> <button class="btn-action btn-delete" onclick="openDeleteModal(${
                    u.id
                  }, 'user', '${u.username}')">‡∏•‡∏ö</button>`
                : '<span style="color:#ccc;">-</span>';
            row.innerHTML = `<td>${u.username}</td><td>${
              u.fullname
            }</td><td>${roleBadge}</td><td>${new Date(
              u.created_at
            ).toLocaleDateString("th-TH")}</td><td>${btnActions}</td>`;
            tbody.appendChild(row);
          });
        } catch (e) {
          console.error(e);
        }
      }
      function openUserModal(u = null) {
        document.getElementById("user-modal").style.display = "flex";
        if (u) {
          document.getElementById("u-id").value = u.id;
          document.getElementById("u-user").value = u.username;
          document.getElementById("u-pass").value = "";
          document.getElementById("u-name").value = u.fullname;
          document.getElementById("u-role").value = u.role;
        } else {
          document.getElementById("u-id").value = "";
          document.getElementById("u-user").value = "";
          document.getElementById("u-pass").value = "";
          document.getElementById("u-name").value = "";
          document.getElementById("u-role").value = "cashier";
        }
      }
      async function saveUser() {
        const id = document.getElementById("u-id").value;
        const body = {
          username: document.getElementById("u-user").value,
          password: document.getElementById("u-pass").value,
          fullname: document.getElementById("u-name").value,
          role: document.getElementById("u-role").value,
        };
        if (!body.username) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        const method = id ? "PUT" : "POST";
        const url = id ? "/users/" + id : "/users";
        try {
          const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (res.ok) {
            document.getElementById("user-modal").style.display = "none";
            showSuccess(id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loadUsers();
          } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- Report ---
      function initReport() {
        const today = new Date().toISOString().split("T")[0];
        if (!document.getElementById("rep-start").value) {
          document.getElementById("rep-start").value = today;
          document.getElementById("rep-end").value = today;
          loadReport();
        }
      }
      async function loadReport() {
        const start = document.getElementById("rep-start").value;
        const end = document.getElementById("rep-end").value;
        if (!start || !end) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
        try {
          const res = await fetch(`/admin/report?start=${start}&end=${end}`);
          const orders = await res.json();
          const tbody = document.getElementById("report-table");
          tbody.innerHTML = "";
          let totalSales = 0;
          if (orders.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
          } else {
            orders.forEach((order) => {
              totalSales += parseFloat(order.total_amount);
              const row = document.createElement("tr");
              row.innerHTML = `<td>${new Date(order.sale_date).toLocaleString(
                "th-TH"
              )}</td><td>${
                order.receipt_no
              }</td><td style="font-weight:bold; color:#27ae60;">${parseFloat(
                order.total_amount
              ).toFixed(2)}</td><td>${parseFloat(order.received_amount).toFixed(
                2
              )}</td><td>${parseFloat(order.change_amount).toFixed(2)}</td>`;
              tbody.appendChild(row);
            });
          }
          document.getElementById("rep-total-sales").innerText =
            totalSales.toLocaleString("th-TH", { minimumFractionDigits: 2 });
          document.getElementById("rep-total-bills").innerText = orders.length;
        } catch (e) {
          console.error(e);
        }
      }

      // --- Members (CRM) ---
      async function loadMembers() {
        try {
          const res = await fetch("/members");
          allMembers = await res.json();
          renderMemberTable(allMembers);
        } catch (e) {
          console.error(e);
        }
      }
      function renderMemberTable(data) {
        const tbody = document.getElementById("member-table");
        tbody.innerHTML = "";
        data.forEach((m) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${m.name}</td><td>${
            m.phone
          }</td><td style="font-weight:bold; color:#e67e22;">${
            m.points
          }</td><td>${new Date(m.created_at).toLocaleDateString(
            "th-TH"
          )}</td><td><button class="btn-action btn-edit" onclick='openMemberModal(${JSON.stringify(
            m
          )})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> <button class="btn-action btn-delete" onclick="openDeleteModal(${
            m.id
          }, 'member', '${m.name}')">‡∏•‡∏ö</button></td>`;
          tbody.appendChild(row);
        });
      }
      function filterMembers() {
        const txt = document
          .getElementById("search-member")
          .value.toLowerCase();
        const filtered = allMembers.filter(
          (m) => m.name.toLowerCase().includes(txt) || m.phone.includes(txt)
        );
        renderMemberTable(filtered);
      }
      function openMemberModal(m = null) {
        document.getElementById("member-modal").style.display = "flex";
        if (m) {
          document.getElementById("mem-modal-title").innerText =
            "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
          document.getElementById("mem-id").value = m.id;
          document.getElementById("mem-name").value = m.name;
          document.getElementById("mem-phone").value = m.phone;
          document.getElementById("mem-points").value = m.points;
        } else {
          document.getElementById("mem-modal-title").innerText =
            "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà";
          document.getElementById("mem-id").value = "";
          document.getElementById("mem-name").value = "";
          document.getElementById("mem-phone").value = "";
          document.getElementById("mem-points").value = "0";
        }
      }
      async function saveMember() {
        const id = document.getElementById("mem-id").value;
        const body = {
          name: document.getElementById("mem-name").value,
          phone: document.getElementById("mem-phone").value,
          points: document.getElementById("mem-points").value || 0,
        };
        if (!body.name || !body.phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
        const method = id ? "PUT" : "POST";
        const url = id ? "/members/" + id : "/members";
        try {
          const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (res.ok) {
            document.getElementById("member-modal").style.display = "none";
            showSuccess(id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loadMembers();
          } else {
            const err = await res.json();
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
          }
        } catch (e) {
          console.error(e);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Stock Card
      async function viewStockHistory(productId, productName) {
        document.getElementById("history-modal").style.display = "flex";
        document.getElementById("hist-product-name").innerText =
          "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: " + productName;
        const tbody = document.getElementById("history-table-body");
        tbody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

        try {
          const res = await fetch(`/stock/card/${productId}`);
          const logs = await res.json();

          tbody.innerHTML = "";
          if (logs.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>';
            return;
          }

          logs.forEach((log) => {
            const changeColor =
              log.qty_change > 0
                ? "green"
                : log.qty_change < 0
                ? "red"
                : "black";
            const changeText =
              log.qty_change > 0 ? `+${log.qty_change}` : log.qty_change;

            tbody.innerHTML += `
                    <tr>
                        <td style="font-size:0.9em;">${new Date(
                          log.created_at
                        ).toLocaleString("th-TH")}</td>
                        <td>${log.action_type}</td>
                        <td style="color:${changeColor}; font-weight:bold;">${changeText}</td>
                        <td style="font-weight:bold;">${log.balance_after}</td>
                        <td style="font-size:0.9em; color:#666;">${
                          log.details
                        }</td>
                    </tr>
                  `;
          });
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
        }
      }

      async function uploadExcel(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append("file", file);

        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå " + file.name + "?")) {
          input.value = "";
          return;
        }

        try {
          const res = await fetch("/products/import", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();

          if (res.ok) {
            alert("‚úÖ " + result.message);
            loadStock();
          } else {
            alert("‚ùå " + result.message);
          }
        } catch (e) {
          console.error(e);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        }

        input.value = "";
      }

      function openBarcodeModal(code, name, price) {
        if (!code || code === "null" || code === "undefined")
          return alert("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î");

        document.getElementById("barcode-modal").style.display = "flex";
        document.getElementById("barcode-name").innerText = name;
        document.getElementById("barcode-price").innerText =
          parseFloat(price).toFixed(2) + " ‡∏ø";

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô Modal
        try {
          JsBarcode("#barcode-preview", code, {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 50,
            displayValue: true,
          });

          //‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏£‡∏¥‡∏á
          document.getElementById("p-name").innerText = name;
          document.getElementById("p-price").innerText =
            parseFloat(price).toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
          JsBarcode("#p-barcode", code, {
            format: "CODE128",
            width: 1.5,
            height: 40,
            fontSize: 12,
            margin: 0,
            displayValue: true,
          });
        } catch (e) {
          console.error(e);
          alert("‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)");
          document.getElementById("barcode-modal").style.display = "none";
        }
      }

      function printBarcode() {
        document.body.classList.add("printing-barcode");
        window.print();
        setTimeout(() => {
          document.body.classList.remove("printing-barcode");
        }, 500);
      }

      // --- Logout ---
      function openLogoutModal() {
        document.getElementById("logout-modal").style.display = "flex";
      }
      function closeLogoutModal() {
        document.getElementById("logout-modal").style.display = "none";
      }
      function confirmLogout() {
        sessionStorage.removeItem("pos_user");
        window.location.href = "/view/login.html";
      }

      function openSubTab(tabId, btn) {
        document
          .querySelectorAll(".tab-content-area")
          .forEach((el) => el.classList.remove("active"));

        document
          .querySelectorAll(".settings-tab-btn")
          .forEach((el) => el.classList.remove("active"));

        const target = document.getElementById(tabId);
        if (target) target.classList.add("active");

        if (btn) btn.classList.add("active");
      }

      function exportReport() {
        const start = document.getElementById("rep-start").value;
        const end = document.getElementById("rep-end").value;

        if (!start || !end) {
          return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        window.location.href = `/admin/export-report?start=${start}&end=${end}`;
      }

      function backupDatabase() {
        window.location.href = "/admin/backup";
      }
    </script>
  </body>
</html>
